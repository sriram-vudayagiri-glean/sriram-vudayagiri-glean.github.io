<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Session Log Viewer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23CC9B7A'/%3E%3Ctext x='50' y='70' font-size='60' font-family='Arial, sans-serif' font-weight='bold' text-anchor='middle' fill='white'%3EC%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .message-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            color: #1f2937;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .tool-card {
            transition: all 0.2s ease-in-out;
        }
        .tool-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .sub-agent-container {
            border-left: 3px solid #3b82f6;
            background: linear-gradient(to right, #eff6ff 0%, #ffffff 100%);
        }
        .expandable-section {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.15s ease-in-out;
        }
        .expandable-section:hover {
            background-color: #e0e7ff;
        }
        .expand-icon {
            transition: transform 0.2s ease-in-out;
        }
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        .hidden-content {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

<div class="container mx-auto p-4 md:p-8 max-w-7xl">
    <!-- Header -->
    <header class="bg-white p-6 rounded-xl shadow-md mb-8 border border-slate-200">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-12 h-12 flex-shrink-0">
                    <rect width="100" height="100" rx="20" fill="#CC9B7A"/>
                    <text x="50" y="70" font-size="60" font-family="Arial, sans-serif" font-weight="bold" text-anchor="middle" fill="white">C</text>
                </svg>
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Claude Session Log Viewer</h1>
                    <p class="text-slate-500 mt-1">View conversation logs with sub-agent categorization and tool use grouping</p>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-4 pt-4 border-t border-slate-200">
            <ul class="text-sm text-slate-600 space-y-1">
                <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                    <span>View single session files or upload a project directory to browse all sessions</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                    <span>Full trace of tools and sub-agents called during execution</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-0.5">‚Ä¢</span>
                    <span>Tool use and results are merged together for easier reading</span>
                </li>
            </ul>
        </div>
    </header>

    <!-- Input Section -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border border-slate-200">
        <h2 class="text-xl font-semibold text-slate-800 mb-4">Load Session Logs</h2>

        <!-- Upload Mode Tabs -->
        <div class="flex gap-2 mb-4">
            <button id="fileModeBtn" class="px-4 py-2 rounded-lg font-medium text-sm bg-blue-100 text-blue-700">
                Single File
            </button>
            <button id="dirModeBtn" class="px-4 py-2 rounded-lg font-medium text-sm bg-slate-100 text-slate-600">
                Project Directory
            </button>
        </div>

        <!-- Upload Mode -->
        <div class="space-y-4">
            <!-- File Upload -->
            <div id="fileUploadSection">
                <label for="fileInput" class="block text-sm font-medium text-slate-700 mb-2">Upload JSONL File</label>
                <input
                    type="file"
                    id="fileInput"
                    accept=".jsonl"
                    class="block w-full text-sm text-slate-500
                        file:mr-4 file:py-3 file:px-6
                        file:rounded-lg file:border-0
                        file:text-sm file:font-medium
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100
                        cursor-pointer"
                >
                <p class="text-xs text-slate-500 mt-2">Select a JSONL file containing conversation logs</p>
            </div>

            <!-- Directory Upload -->
            <div id="dirUploadSection" class="hidden">
                <label for="dirInput" class="block text-sm font-medium text-slate-700 mb-2">Upload Project Directory</label>
                <input
                    type="file"
                    id="dirInput"
                    webkitdirectory
                    directory
                    multiple
                    class="block w-full text-sm text-slate-500
                        file:mr-4 file:py-3 file:px-6
                        file:rounded-lg file:border-0
                        file:text-sm file:font-medium
                        file:bg-purple-50 file:text-purple-700
                        hover:file:bg-purple-100
                        cursor-pointer"
                >
                <p class="text-xs text-slate-500 mt-2">Select a Claude Code project directory (e.g., ~/.claude/projects/...)</p>
                <p class="text-xs text-amber-600 mt-1 font-medium">‚è≥ Processing may take a few seconds for large directories</p>
            </div>

            <!-- Session Selector (shown when directory is loaded) -->
            <div id="sessionSelectorSection" class="hidden mt-4">
                <label for="sessionSelect" class="block text-sm font-medium text-slate-700 mb-2">Select Session</label>
                <select id="sessionSelect" class="block w-full px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Choose a session...</option>
                </select>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center gap-3">
                <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-red-700 font-medium" id="errorMessage">Error loading logs</span>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="logContainer" class="space-y-6">
        <!-- Initial placeholder -->
        <div id="placeholder" class="text-center py-20 px-6 bg-white rounded-xl shadow-md border border-slate-200">
            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-lg font-medium text-slate-900">No session loaded</h3>
            <p class="mt-1 text-sm text-slate-500">Upload a JSONL file to view conversation logs</p>
        </div>
    </main>
</div>

<script>
// Sample session data
const SAMPLE_SESSION_DATA = `{"type":"file-history-snapshot","messageId":"ad43aece-e51d-485b-ba03-3b4ed650e1a9","snapshot":{"messageId":"ad43aece-e51d-485b-ba03-3b4ed650e1a9","trackedFileBackups":{},"timestamp":"2025-12-17T11:01:18.413Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","type":"user","message":{"role":"user","content":"<command-message>x is running‚Ä¶</command-message>\\n<command-name>/x</command-name>\\n<command-args>do it</command-args>"},"uuid":"ad43aece-e51d-485b-ba03-3b4ed650e1a9","timestamp":"2025-12-17T11:01:18.410Z"}
{"parentUuid":"ad43aece-e51d-485b-ba03-3b4ed650e1a9","isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","type":"user","message":{"role":"user","content":[{"type":"text","text":"1. Call agent Y.\\n2. Print the current date and time.\\n\\nARGUMENTS: do it"}]},"isMeta":true,"uuid":"b1414c31-b44e-46db-9d54-28ec89f690b8","timestamp":"2025-12-17T11:01:18.410Z"}
{"parentUuid":"b1414c31-b44e-46db-9d54-28ec89f690b8","isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01QNcfp4SunZRff4hCw1BzqB","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you execute this task. Let me call agent Y first, then print the current date and time."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":62845,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":62845,"ephemeral_1h_input_tokens":0},"output_tokens":5}},"requestId":"req_vrtx_011CWC9MU6LZhYiqSRahUG3b","type":"assistant","uuid":"ee82a98a-5490-440d-bbc0-f0964acbf5fd","timestamp":"2025-12-17T11:01:23.827Z"}
{"parentUuid":"ee82a98a-5490-440d-bbc0-f0964acbf5fd","isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01QNcfp4SunZRff4hCw1BzqB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_vrtx_01BE5vcJN3hEy8MCdCex9fbB","name":"Task","input":{"subagent_type":"y","description":"Call agent Y","prompt":"Execute agent Y task with argument: do it"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":62845,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":62845,"ephemeral_1h_input_tokens":0},"output_tokens":5}},"requestId":"req_vrtx_011CWC9MU6LZhYiqSRahUG3b","type":"assistant","uuid":"68c17a21-2066-4364-b70c-3853440f3d22","timestamp":"2025-12-17T11:01:25.224Z"}
{"parentUuid":"68c17a21-2066-4364-b70c-3853440f3d22","isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01QNcfp4SunZRff4hCw1BzqB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_vrtx_01CEgApP6NKyc5EQGp4bWAfk","name":"Bash","input":{"command":"date","description":"Print current date and time"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":62845,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":62845,"ephemeral_1h_input_tokens":0},"output_tokens":179}},"requestId":"req_vrtx_011CWC9MU6LZhYiqSRahUG3b","type":"assistant","uuid":"927d6634-923c-41dc-8ccf-fd27a7f8afb4","timestamp":"2025-12-17T11:01:25.638Z"}
{"parentUuid":"927d6634-923c-41dc-8ccf-fd27a7f8afb4","isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_vrtx_01CEgApP6NKyc5EQGp4bWAfk","type":"tool_result","content":"Wed Dec 17 16:31:29 IST 2025","is_error":false}]},"uuid":"9a648929-abe7-4240-a58e-659e39ea8030","timestamp":"2025-12-17T11:01:29.865Z","toolUseResult":{"stdout":"Wed Dec 17 16:31:29 IST 2025","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"9a648929-abe7-4240-a58e-659e39ea8030","isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","slug":"sparkling-swinging-oasis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_vrtx_01BE5vcJN3hEy8MCdCex9fbB","type":"tool_result","content":[{"type":"text","text":"The current date and time is: **Wed Dec 17 16:31:33 IST 2025**\\n\\nI've read agent Y's instructions, which ask me to print the current date and time (done above) and say bye.\\n\\nBye! üëã"},{"type":"text","text":"agentId: aec93c0 (for resuming to continue this agent's work if needed)"}]}]},"uuid":"a17591b2-9e04-45c5-9817-57a008a7ff04","timestamp":"2025-12-17T11:01:37.170Z","toolUseResult":{"status":"completed","prompt":"Execute agent Y task with argument: do it","agentId":"aec93c0","content":[{"type":"text","text":"The current date and time is: **Wed Dec 17 16:31:33 IST 2025**\\n\\nI've read agent Y's instructions, which ask me to print the current date and time (done above) and say bye.\\n\\nBye! üëã"}],"totalDurationMs":11487,"totalTokens":43419,"totalToolUseCount":2,"usage":{"input_tokens":175,"cache_creation_input_tokens":193,"cache_read_input_tokens":42989,"cache_creation":{"ephemeral_5m_input_tokens":193,"ephemeral_1h_input_tokens":0},"output_tokens":62}}}
{"parentUuid":"a17591b2-9e04-45c5-9817-57a008a7ff04","isSidechain":false,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","slug":"sparkling-swinging-oasis","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01UCJtyYw4TyR2Rs2ZHfXTr8","type":"message","role":"assistant","content":[{"type":"text","text":"Agent Y has completed its task and says bye!\\n\\nCurrent date and time: **Wed Dec 17 16:31:29 IST 2025**"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":47,"cache_creation_input_tokens":299,"cache_read_input_tokens":62845,"cache_creation":{"ephemeral_5m_input_tokens":299,"ephemeral_1h_input_tokens":0},"output_tokens":37}},"requestId":"req_vrtx_011CWC9NktuQxyRGzE7wgKoo","type":"assistant","uuid":"fa5ad6b3-f000-410b-8c52-130211b8b834","timestamp":"2025-12-17T11:01:41.010Z"}
{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","agentId":"aec93c0","type":"user","message":{"role":"user","content":"Execute agent Y task with argument: do it"},"uuid":"c06f8adb-6a6b-4708-be14-446003f462cf","timestamp":"2025-12-17T11:01:25.701Z"}
{"parentUuid":"c06f8adb-6a6b-4708-be14-446003f462cf","isSidechain":true,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","agentId":"aec93c0","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01HmuJaSEMn5qiu86aZaXMWu","type":"message","role":"assistant","content":[{"type":"text","text":"I'll print the current date and time, execute agent Y, and then say goodbye."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":42989,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":42989,"ephemeral_1h_input_tokens":0},"output_tokens":3}},"requestId":"req_vrtx_011CWC9N1MXbye4CfNfTUucs","type":"assistant","uuid":"3d28e204-f055-4867-96c4-71d785915a9e","timestamp":"2025-12-17T11:01:31.022Z"}
{"parentUuid":"3d28e204-f055-4867-96c4-71d785915a9e","isSidechain":true,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","agentId":"aec93c0","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01HmuJaSEMn5qiu86aZaXMWu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_vrtx_013CttQqBfkmwCi616TmVBmU","name":"Bash","input":{"command":"date","description":"Print current date and time"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":42989,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":42989,"ephemeral_1h_input_tokens":0},"output_tokens":3}},"requestId":"req_vrtx_011CWC9N1MXbye4CfNfTUucs","type":"assistant","uuid":"ea9ede4f-e621-4254-a430-fa4657c08a1b","timestamp":"2025-12-17T11:01:31.523Z"}
{"parentUuid":"ea9ede4f-e621-4254-a430-fa4657c08a1b","isSidechain":true,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","agentId":"aec93c0","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01HmuJaSEMn5qiu86aZaXMWu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_vrtx_0122Yoskiw4cAodvPeQ2pcG1","name":"Read","input":{"file_path":"/Users/ram/workspace/scio/.claude/agents/y.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":42989,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":42989,"ephemeral_1h_input_tokens":0},"output_tokens":144}},"requestId":"req_vrtx_011CWC9N1MXbye4CfNfTUucs","type":"assistant","uuid":"edd283bb-c8b0-46e8-99bd-20d91222dea6","timestamp":"2025-12-17T11:01:32.212Z"}
{"parentUuid":"edd283bb-c8b0-46e8-99bd-20d91222dea6","isSidechain":true,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","agentId":"aec93c0","slug":"sparkling-swinging-oasis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_vrtx_0122Yoskiw4cAodvPeQ2pcG1","type":"tool_result","content":"     1‚Üí---\\n     2‚Üíname: y\\n     3‚Üídescription: Agent Y\\n     4‚Üímodel: sonnet\\n     5‚Üícolor: blue\\n     6‚Üí---\\n     7‚Üí\\n     8‚ÜíPrint the current date and time.\\n     9‚Üí\\n    10‚ÜíSay bye.\\n\\n<system-reminder>\\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\\n</system-reminder>\\n"}]},"uuid":"09d67f21-c190-4857-ae6f-a43c16f65e41","timestamp":"2025-12-17T11:01:32.273Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/ram/workspace/scio/.claude/agents/y.md","content":"---\\nname: y\\ndescription: Agent Y\\nmodel: sonnet\\ncolor: blue\\n---\\n\\nPrint the current date and time.\\n\\nSay bye.","numLines":10,"startLine":1,"totalLines":10}}}
{"parentUuid":"09d67f21-c190-4857-ae6f-a43c16f65e41","isSidechain":true,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","agentId":"aec93c0","slug":"sparkling-swinging-oasis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_vrtx_013CttQqBfkmwCi616TmVBmU","type":"tool_result","content":"Wed Dec 17 16:31:33 IST 2025","is_error":false}]},"uuid":"d6444ece-339c-4a28-bf0a-9eafba10d2ca","timestamp":"2025-12-17T11:01:33.183Z","toolUseResult":{"stdout":"Wed Dec 17 16:31:33 IST 2025","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"d6444ece-339c-4a28-bf0a-9eafba10d2ca","isSidechain":true,"userType":"external","cwd":"/Users/ram/workspace/scio","sessionId":"1d63cb62-bfa6-40d7-8449-13c2078c961b","version":"2.0.71","gitBranch":"master","agentId":"aec93c0","slug":"sparkling-swinging-oasis","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_vrtx_01Nm1d1VDQnX7Rzdj9U6epYS","type":"message","role":"assistant","content":[{"type":"text","text":"The current date and time is: **Wed Dec 17 16:31:33 IST 2025**\\n\\nI've read agent Y's instructions, which ask me to print the current date and time (done above) and say bye.\\n\\nBye! üëã"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":175,"cache_creation_input_tokens":193,"cache_read_input_tokens":42989,"cache_creation":{"ephemeral_5m_input_tokens":193,"ephemeral_1h_input_tokens":0},"output_tokens":62}},"requestId":"req_vrtx_011CWC9NTm2KBUj8NZNWeiNE","type":"assistant","uuid":"67098763-9fe5-45b6-8e41-070677d0dba0","timestamp":"2025-12-17T11:01:37.135Z"}`;

// Global state
let allLogs = [];
let expandedTools = new Set();
let expandedSubAgents = new Set();
let projectSessions = {}; // Store parsed project sessions

// DOM Elements
const fileInput = document.getElementById('fileInput');
const dirInput = document.getElementById('dirInput');
const fileModeBtn = document.getElementById('fileModeBtn');
const dirModeBtn = document.getElementById('dirModeBtn');
const fileUploadSection = document.getElementById('fileUploadSection');
const dirUploadSection = document.getElementById('dirUploadSection');
const sessionSelectorSection = document.getElementById('sessionSelectorSection');
const sessionSelect = document.getElementById('sessionSelect');
const errorState = document.getElementById('errorState');
const logContainer = document.getElementById('logContainer');
const placeholder = document.getElementById('placeholder');

// Event Listeners
fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    hideError();
    const reader = new FileReader();
    reader.onload = (e) => {
        const content = e.target.result;
        try {
            const logs = parseNDJSON(content);
            displayLogs(logs);
        } catch (error) {
            showError(`Failed to parse JSONL file: ${error.message}`);
        }
    };
    reader.onerror = () => {
        showError('Failed to read the file');
    };
    reader.readAsText(file);
});

dirInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    hideError();
    try {
        await parseProjectDirectory(files);
    } catch (error) {
        showError(`Failed to parse project directory: ${error.message}`);
    }
});

sessionSelect.addEventListener('change', (e) => {
    const sessionId = e.target.value;
    if (!sessionId || !projectSessions[sessionId]) return;

    try {
        const mergedLogs = mergeSessionLogs(sessionId);
        displayLogs(mergedLogs);
    } catch (error) {
        showError(`Failed to load session: ${error.message}`);
    }
});

fileModeBtn.addEventListener('click', () => {
    fileModeBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm bg-blue-100 text-blue-700';
    dirModeBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm bg-slate-100 text-slate-600';
    fileUploadSection.classList.remove('hidden');
    dirUploadSection.classList.add('hidden');
    sessionSelectorSection.classList.add('hidden');
});

dirModeBtn.addEventListener('click', () => {
    dirModeBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm bg-purple-100 text-purple-700';
    fileModeBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm bg-slate-100 text-slate-600';
    fileUploadSection.classList.add('hidden');
    dirUploadSection.classList.remove('hidden');
});

// Parsing Functions
async function parseProjectDirectory(files) {
    projectSessions = {};

    // Collect all JSONL files (flatten directory structure)
    const jsonlFiles = files.filter(f => f.name.endsWith('.jsonl'));

    // Separate session files from agent files
    const sessionFiles = jsonlFiles.filter(f => !f.name.startsWith('agent-'));
    const agentFiles = jsonlFiles.filter(f => f.name.startsWith('agent-'));

    // Parse all files and group by sessionId
    const parsePromises = sessionFiles.map(async (sessionFile) => {
        try {
            // Read session file
            const sessionContent = await readFileAsText(sessionFile);
            const sessionLogs = parseNDJSON(sessionContent);

            if (!sessionLogs.length) return null;

            // Extract session metadata
            const firstLog = sessionLogs[0];
            // Try to get sessionId from log, fallback to filename (without .jsonl extension)
            const sessionId = firstLog.sessionId || sessionFile.name.replace('.jsonl', '');

            if (!sessionId) {
                return null;
            }

            // Find the first valid timestamp from the logs
            let timestamp = null;
            for (const log of sessionLogs) {
                if (log.timestamp) {
                    timestamp = log.timestamp;
                    break;
                }
            }

            // If no timestamp found, use a very old date to sort to the end
            if (!timestamp) {
                timestamp = '1970-01-01T00:00:00.000Z';
            }

            // Find matching agent files by reading them and checking sessionId
            const matchingAgentLogs = [];

            for (const agentFile of agentFiles) {
                const agentContent = await readFileAsText(agentFile);
                const agentLogs = parseNDJSON(agentContent);

                // Check if this agent file belongs to this session
                if (agentLogs.length > 0 && agentLogs[0].sessionId === sessionId) {
                    matchingAgentLogs.push(...agentLogs);
                }
            }

            projectSessions[sessionId] = {
                sessionId,
                timestamp,
                sessionLogs,
                agentLogs: matchingAgentLogs,
                allLogs: [...sessionLogs, ...matchingAgentLogs]
            };

            return { sessionId, timestamp };
        } catch (error) {
            return null;
        }
    });

    const results = (await Promise.all(parsePromises)).filter(r => r !== null);

    if (results.length === 0) {
        const foundFiles = files.filter(f => f.name.endsWith('.jsonl')).length;
        throw new Error(
            `No valid sessions found in directory. ` +
            `Found ${foundFiles} JSONL file(s).`
        );
    }

    // Populate dropdown
    populateSessionDropdown(results);
}

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
    });
}

function populateSessionDropdown(sessions) {
    // Sort sessions by timestamp (newest first)
    sessions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    sessionSelect.innerHTML = '<option value="">Choose a session...</option>';

    sessions.forEach(({ sessionId, timestamp }) => {
        const option = document.createElement('option');
        option.value = sessionId;

        let formattedDate;
        if (timestamp === '1970-01-01T00:00:00.000Z') {
            formattedDate = 'No timestamp';
        } else {
            const date = new Date(timestamp);
            formattedDate = date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        option.textContent = `${sessionId.substring(0, 8)}... - ${formattedDate}`;
        sessionSelect.appendChild(option);
    });

    sessionSelectorSection.classList.remove('hidden');
}

function mergeSessionLogs(sessionId) {
    const session = projectSessions[sessionId];
    if (!session) {
        throw new Error('Session not found');
    }

    // Return all logs (session + agent logs merged)
    return session.allLogs;
}

function parseNDJSON(content) {
    const lines = content.trim().split('\n');
    const logs = [];

    lines.forEach((line, index) => {
        if (line.trim() === '') return;
        try {
            const parsed = JSON.parse(line);
            // Filter out file-history-snapshot entries
            if (parsed.type === 'file-history-snapshot') return;
            logs.push(parsed);
        } catch (error) {
            // Skip malformed JSON
        }
    });

    return logs;
}

// Data Structure Building
function buildDataStructures(logs) {
    // Separate main logs from sub-agents
    const mainLogs = logs.filter(log => !log.isSidechain);
    const subAgentLogs = {};

    logs.filter(log => log.isSidechain).forEach(log => {
        const agentId = log.agentId;
        if (!subAgentLogs[agentId]) subAgentLogs[agentId] = [];
        subAgentLogs[agentId].push(log);
    });

    // Build tool use to result mapping
    const toolUseMap = new Map();

    logs.forEach(log => {
        if (log.message?.content) {
            const content = Array.isArray(log.message.content) ? log.message.content : [log.message.content];

            content.forEach(item => {
                if (item.type === 'tool_use') {
                    toolUseMap.set(item.id, {
                        toolUse: item,
                        toolUseLog: log,
                        result: null,
                        resultLog: null,
                        agentId: null
                    });
                }
            });
        }
    });

    // Link tool results to tool uses
    logs.forEach(log => {
        if (log.message?.content) {
            const content = Array.isArray(log.message.content) ? log.message.content : [log.message.content];

            content.forEach(item => {
                if (item.type === 'tool_result' && item.tool_use_id) {
                    const toolData = toolUseMap.get(item.tool_use_id);
                    if (toolData) {
                        toolData.result = item;
                        toolData.resultLog = log;

                        // Extract agentId if this is a Task tool result
                        if (toolData.toolUse.name === 'Task') {
                            try {
                                let textContent = '';

                                // Handle both string and array content
                                if (typeof item.content === 'string') {
                                    textContent = item.content;
                                } else if (Array.isArray(item.content)) {
                                    textContent = item.content
                                        .filter(c => c.type === 'text')
                                        .map(c => c.text)
                                        .join('\n');
                                }

                                const match = textContent.match(/agentId:\s*([a-f0-9]+)/);
                                if (match) {
                                    toolData.agentId = match[1];
                                }
                            } catch (e) {
                                // Error extracting agentId
                            }
                        }
                    }
                }
            });
        }
    });

    return { mainLogs, subAgentLogs, toolUseMap };
}

// Display Functions
function displayLogs(logs, isSample = false) {
    allLogs = logs;
    const { mainLogs, subAgentLogs, toolUseMap } = buildDataStructures(logs);

    logContainer.innerHTML = '';
    placeholder.style.display = 'none';

    // Create session container
    const sessionContainer = document.createElement('div');
    sessionContainer.className = 'bg-white p-6 rounded-xl shadow-md border border-slate-200';

    // Add session header
    const header = createSessionHeader(logs, isSample);
    sessionContainer.appendChild(header);

    // Render main timeline
    const timeline = document.createElement('div');
    timeline.className = 'space-y-4 mt-6';

    mainLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    mainLogs.forEach(log => {
        const logElement = createLogElement(log, toolUseMap, subAgentLogs, 0);
        if (logElement) timeline.appendChild(logElement);
    });

    sessionContainer.appendChild(timeline);
    logContainer.appendChild(sessionContainer);
}

function createSessionHeader(logs, isSample = false) {
    const header = document.createElement('div');
    header.className = 'border-b border-slate-200 pb-4 mb-4';

    const sessionInfo = logs[0] || {};
    const sessionId = sessionInfo.sessionId || 'Unknown';

    // Calculate metadata
    let totalInputTokens = 0;
    let totalOutputTokens = 0;
    let totalCacheCreation = 0;
    let totalCacheRead = 0;

    logs.forEach(log => {
        if (log.message?.usage) {
            totalInputTokens += log.message.usage.input_tokens || 0;
            totalOutputTokens += log.message.usage.output_tokens || 0;
            totalCacheCreation += log.message.usage.cache_creation_input_tokens || 0;
            totalCacheRead += log.message.usage.cache_read_input_tokens || 0;
        }
    });

    const sampleBadge = isSample ? '<span class="ml-2 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-md">Sample Session</span>' : '';

    header.innerHTML = `
        <h2 class="text-xl font-semibold text-slate-700 mb-3">
            <span class="text-slate-500 text-sm mr-2">Session Id:</span>
            <span class="font-mono bg-slate-100 text-slate-600 px-2 py-1 rounded-md text-sm">${sessionId}</span>
            ${sampleBadge}
        </h2>
        <div class="flex flex-wrap gap-x-6 gap-y-1 text-xs text-slate-500 font-mono">
            <div><span class="font-semibold text-slate-600">Input Tokens:</span> ${totalInputTokens.toLocaleString()}</div>
            <div><span class="font-semibold text-slate-600">Output Tokens:</span> ${totalOutputTokens.toLocaleString()}</div>
            ${totalCacheCreation > 0 ? `<div><span class="font-semibold text-slate-600">Cache Creation:</span> ${totalCacheCreation.toLocaleString()}</div>` : ''}
            ${totalCacheRead > 0 ? `<div><span class="font-semibold text-slate-600">Cache Read:</span> ${totalCacheRead.toLocaleString()}</div>` : ''}
        </div>
    `;

    return header;
}

function createLogElement(log, toolUseMap, subAgentLogs, nestLevel) {
    const role = log.message?.role || log.type || 'system';

    // Skip summary messages
    if (role === 'summary' || log.type === 'summary') {
        return null;
    }

    // Skip rendering if this log is part of tool use/result pair
    if (log.message?.content) {
        const content = Array.isArray(log.message.content) ? log.message.content : [];
        const hasToolUse = content.some(item => item.type === 'tool_use');
        const hasToolResult = content.some(item => item.type === 'tool_result');

        if (hasToolUse) {
            // Render tool use cards
            return createToolUseElements(log, toolUseMap, subAgentLogs, nestLevel);
        } else if (hasToolResult && role === 'user') {
            // Skip tool result logs (they're rendered as part of tool cards)
            return null;
        }
    }

    // Render regular message
    const messageContent = formatMessageContent(log.message?.content);

    // Skip rendering if content is empty
    if (!messageContent || messageContent.trim() === '' || messageContent === '<p></p>') {
        return null;
    }

    const element = document.createElement('div');
    const indent = nestLevel * 20;
    element.style.marginLeft = `${indent}px`;

    const isUser = role.toLowerCase() === 'user';
    const bgColor = isUser ? 'bg-blue-50' : 'bg-slate-50';
    const borderColor = isUser ? 'border-blue-200' : 'border-slate-200';
    const roleColor = isUser ? 'bg-blue-200 text-blue-800' : 'bg-slate-200 text-slate-800';

    element.className = `p-4 rounded-lg border ${bgColor} ${borderColor}`;

    const timestamp = new Date(log.timestamp).toLocaleString();

    element.innerHTML = `
        <div class="flex justify-between items-center text-sm mb-3">
            <span class="px-2.5 py-0.5 rounded-full font-semibold text-xs uppercase ${roleColor}">${role}</span>
            <span class="text-slate-500 font-mono text-xs">${timestamp}</span>
        </div>
        <div class="message-content text-sm">
            ${messageContent}
        </div>
    `;

    return element;
}

function createToolUseElements(log, toolUseMap, subAgentLogs, nestLevel) {
    const container = document.createElement('div');
    container.className = 'space-y-2';
    const indent = nestLevel * 20;
    container.style.marginLeft = `${indent}px`;

    const content = Array.isArray(log.message.content) ? log.message.content : [];

    content.forEach(item => {
        if (item.type === 'tool_use') {
            const toolData = toolUseMap.get(item.id);
            if (!toolData) return;

            const toolCard = createToolCard(toolData, toolUseMap, subAgentLogs, nestLevel);
            container.appendChild(toolCard);
        } else if (item.type === 'text' && item.text && item.text.trim()) {
            // Render assistant text before tool uses (only if not empty)
            const textElement = document.createElement('div');
            textElement.className = `p-4 rounded-lg border bg-slate-50 border-slate-200`;
            textElement.innerHTML = `
                <div class="flex justify-between items-center text-sm mb-3">
                    <span class="px-2.5 py-0.5 rounded-full font-semibold text-xs uppercase bg-slate-200 text-slate-800">ASSISTANT</span>
                    <span class="text-slate-500 font-mono text-xs">${new Date(log.timestamp).toLocaleString()}</span>
                </div>
                <div class="message-content text-sm">
                    <p>${escapeHtml(item.text).replace(/\n/g, '<br>')}</p>
                </div>
            `;
            container.appendChild(textElement);
        }
    });

    return container.children.length > 0 ? container : null;
}

function createToolCard(toolData, toolUseMap, subAgentLogs, nestLevel) {
    const { toolUse, result, agentId } = toolData;
    const toolId = toolUse.id;
    const isExpanded = expandedTools.has(toolId);

    const card = document.createElement('div');
    card.className = 'tool-card border-2 border-indigo-200 rounded-lg bg-indigo-50 overflow-hidden';

    // Header
    const header = document.createElement('div');
    header.className = 'expandable-section p-4 bg-indigo-100 flex justify-between items-center';

    // Extract sub-agent name from input if it's a Task tool
    let displayName = toolUse.name;
    if (agentId) {
        const subAgentType = toolUse.input?.subagent_type || 'Unknown';
        displayName = `Sub-agent: ${subAgentType}`;
    }

    header.innerHTML = `
        <div class="flex items-center gap-2">
            <span class="text-lg">üîß</span>
            <span class="font-semibold text-indigo-900">TOOL: ${displayName}</span>
            <span class="text-xs text-indigo-600 ml-2">(click to expand)</span>
        </div>
        <span class="expand-icon ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>
    `;

    header.addEventListener('click', () => {
        if (expandedTools.has(toolId)) {
            expandedTools.delete(toolId);
            outputSection.classList.add('hidden-content');
            header.querySelector('.expand-icon').classList.remove('expanded');
        } else {
            expandedTools.add(toolId);
            outputSection.classList.remove('hidden-content');
            header.querySelector('.expand-icon').classList.add('expanded');
        }
    });

    card.appendChild(header);

    // Input section (always visible)
    const inputSection = document.createElement('div');
    inputSection.className = 'p-4 border-t border-indigo-200';
    inputSection.innerHTML = `
        <div class="text-xs font-semibold text-indigo-700 mb-2">Input:</div>
        <pre class="text-xs bg-white p-3 rounded border border-indigo-200 overflow-x-auto">${escapeHtml(JSON.stringify(toolUse.input, null, 2))}</pre>
    `;
    card.appendChild(inputSection);

    // Output section (expandable)
    const outputSection = document.createElement('div');
    outputSection.className = isExpanded ? '' : 'hidden-content';

    // Sub-agent section (if applicable)
    if (agentId && subAgentLogs[agentId]) {
        const subAgentContainer = document.createElement('div');
        subAgentContainer.className = 'sub-agent-container p-4 mt-2 rounded-lg';

        const subAgentHeader = document.createElement('div');
        subAgentHeader.className = 'font-semibold text-blue-700 mb-3 text-sm flex items-center gap-2';
        subAgentHeader.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <span>SUB-AGENT EXECUTION: ${agentId}</span>
        `;
        subAgentContainer.appendChild(subAgentHeader);

        const subLogsContainer = document.createElement('div');
        subLogsContainer.className = 'space-y-3';

        const subLogs = subAgentLogs[agentId].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        subLogs.forEach(subLog => {
            // Render sub-agent logs without nesting indent (they're already in a bordered container)
            const subElement = createLogElement(subLog, toolUseMap, {}, 0);
            if (subElement) {
                // Remove any margin-left that was added
                subElement.style.marginLeft = '0px';
                subLogsContainer.appendChild(subElement);
            }
        });

        subAgentContainer.appendChild(subLogsContainer);
        outputSection.appendChild(subAgentContainer);
    }

    // Tool result
    if (result) {
        const resultSection = document.createElement('div');
        resultSection.className = 'p-4 border-t border-indigo-200';
        resultSection.innerHTML = `
            <div class="text-xs font-semibold text-emerald-700 mb-2">Output:</div>
            <div class="text-sm bg-white p-3 rounded border border-emerald-200">${formatToolResult(result)}</div>
        `;
        outputSection.appendChild(resultSection);
    }

    card.appendChild(outputSection);

    return card;
}

function formatMessageContent(content) {
    if (typeof content === 'string') {
        const trimmed = content.trim();
        if (!trimmed) return '';
        return `<p>${escapeHtml(trimmed).replace(/\n/g, '<br>')}</p>`;
    } else if (Array.isArray(content)) {
        const formatted = content.map(item => {
            if (item.type === 'text' && item.text && item.text.trim()) {
                return `<p>${escapeHtml(item.text).replace(/\n/g, '<br>')}</p>`;
            }
            return '';
        }).join('');
        return formatted.trim();
    }
    if (!content) return '';
    return '<pre>' + escapeHtml(JSON.stringify(content, null, 2)) + '</pre>';
}

function formatToolResult(result) {
    if (typeof result.content === 'string') {
        return escapeHtml(result.content).replace(/\n/g, '<br>');
    } else if (Array.isArray(result.content)) {
        return result.content.map(item => {
            if (item.type === 'text') {
                return escapeHtml(item.text).replace(/\n/g, '<br>');
            }
            return '';
        }).join('');
    }
    return escapeHtml(JSON.stringify(result.content, null, 2));
}

function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// UI State Functions
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    errorState.classList.remove('hidden');
}

function hideError() {
    errorState.classList.add('hidden');
}

// Load sample session
function loadSampleSession() {
    try {
        const logs = parseNDJSON(SAMPLE_SESSION_DATA);
        displayLogs(logs, true);
    } catch (error) {
        // Sample session failed to load
    }
}

// Load sample session on page load
window.addEventListener('DOMContentLoaded', () => {
    loadSampleSession();
});
</script>

</body>
</html>
